- job-template:
    name: '{version-id}.test_staging_mirror'
    disabled: true
    description: |
      1. Build custom ISO based on mirror candidate.<br><br>
      2. Run tests for Fuel mirrors candidate builded by<br>
      <b><a href="/job/{version-id}.build_staging_mirror/">{version-id}.build_staging_mirror</a></b>.<br><br>
      3. Update symlink pointed to last stable version of mirrors if tests successfull.<br><br>
      See build description of last successful build here or for <b><a href="/job/{version-id}.set_stable_mirror/">{version-id}.set_stable_mirror</a></b>
      for information about last stable mirror version.<br><br>
      Documentation about mirror staging:<br><br>
      <a href="https://mirantis.jira.com/wiki/pages/viewpage.action?pageId=176655477">How Fuel staging Fuel Mirrors works</a>,<br>
      <a href="https://docs.google.com/a/mirantis.com/document/d/1yrOQMOgmzcY8FxXlGLg6v_Um5Sni6snQg5BA4V24mbE/edit#heading=h.mqzzk07485lc">How mirror staging works</a>.<br><br>
      If you have any questions, contact Devops or OSCI teams via #fuel-devops and #fuel-osci IRC chats.<br>
    concurrent: true
    node: mirror
    properties:
      - heavy-job:
          weight: 1
    parameters:
      - string:
          name: FUEL_MAIN_BRANCH
          default: master
      - string:
          name: MIRROR
          default: '{version-id}'
          description: |
            Autodetected for <b>stable/*</b> branch independent of specified value. 
            Otherwise specify it. For example: <b>{version-id}</b>
      - string:
          name: MIRROR_VERSION
          description: "5.1-2014-08-26-115618"
    builders:
      - shell:
          !include-raw-escape builders/test_staging_mirror_1.sh
      - multijob:
          name: ISO Building
          condition: SUCCESSFUL
          projects:
            - name: '{version-id}.staging.iso'
              kill-phase-on: FAILURE
              property-file: mirror-staging.txt
      - copyartifact:
          project: '{version-id}.staging.iso'
          filter: artifacts/magnet_link.txt
          which-build: last-successful
      - multijob:
          name: ISO Testing
          condition: SUCCESSFUL
          projects:
            - name: '{version-id}.staging.centos.bvt_1'
              kill-phase-on: FAILURE
              property-file: mirror-staging.txt
              current-parameters: true
            - name: '{version-id}.staging.ubuntu.bvt_2'
              kill-phase-on: FAILURE
              property-file: mirror-staging.txt
              current-parameters: true
      - multijob:
          name: Updating Mirrors stable symlink
          condition: SUCCESSFUL
          projects:
            - name: '{version-id}.set_stable_mirror'
              kill-phase-on: FAILURE
              property-file: mirror-staging.txt
      - copyartifact:
          project: '{version-id}.set_stable_mirror'
          filter: build_description.txt
          which-build: last-successful
      - shell:
          !include-raw-escape builders/test_staging_mirror_2.sh
    publishers:
      - description-setter:
          regexp: (^[^\s]* is stable.*a href.*)
          set-for-matrix: false
      - email-ext:
          body: $DEFAULT_CONTENT
          aborted: true
          failure: true
          still-failing: true
          fixed: true
          send-to:
            - recipients
            - requester
          recipients: devops+alert@mirantis.com,fuel-osci@mirantis.com,mos-qa
          subject: '[Jenkins] $DEFAULT_SUBJECT'
